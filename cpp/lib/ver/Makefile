#
# ELASTICSEARCH CONFIDENTIAL
#
# Copyright (c) 2016 Elasticsearch BV. All Rights Reserved.
#
# Notice: this software, and all information contained
# therein, is the exclusive property of Elasticsearch BV
# and its licensors, if any, and is protected under applicable
# domestic and foreign law, and international treaties.
#
# Reproduction, republication or distribution without the
# express written consent of Elasticsearch BV is
# strictly prohibited.
#
include $(CPP_SRC_HOME)/mk/defines.mk

TARGET=$(OBJS_DIR)/libPreVer$(STATIC_LIB_EXT)

USE_BOOST=1

# make clean should remove the generated source file in addition to object files
CLEAN_CMDS=$(RM) CBuildInfo.cc

# Prepare values to substitute into the template
BUILD_YEAR=$(shell date '+%Y')
USER_NAME_CMD=id | awk -F')' '{ print $$1 }' | awk -F'(' '{ print $$2 }'
USER_NAME=$(shell $(USER_NAME_CMD))
PRODUCT_VERSION=$(shell cat $(CPP_SRC_HOME)/../gradle.properties | grep '^elasticsearchVersion' | awk -F= '{ print $$2 }' | xargs echo)
PRELERT_BUILD_NUM=$(shell git rev-parse --short=14 HEAD)

# Decide which template to use based on whether Jenkins is doing the build
ifdef JOB_NAME
TEMPLATE=tagged_template
else
TEMPLATE=dev_template
endif

all: build

SRCS= \
CBuildInfo.cc \

NO_BENCH_MARKS=1

include $(CPP_SRC_HOME)/mk/staticlib.mk

# Declaring this target PHONY means CBuildInfo.cc always gets rebuilt.  This is
# done because CBuildInfo.cc depends on the date and environment variables as
# well as the template.
.PHONY: force

CBuildInfo.cc: force
	@sed "s/@build.year@/$(BUILD_YEAR)/" < CBuildInfo.cc.$(TEMPLATE) \
		| sed "s/@warning.comment@/DO NOT EDIT THIS FILE - instead edit BOTH templates/" \
		| sed "s/@user.name@/$(USER_NAME)/" \
		| sed "s/@version.number@/$(PRODUCT_VERSION)/" \
		| sed "s/@build.number@/$(PRELERT_BUILD_NUM)/" > CBuildInfo.cc.tmp
	@cmp -s CBuildInfo.cc CBuildInfo.cc.tmp || $(MV) CBuildInfo.cc.tmp CBuildInfo.cc && $(RM) CBuildInfo.cc.tmp

