<?xml version="1.0" encoding="UTF-8"?>
<project name="Prelert Proxy NetQoS Plugin" default="build" basedir=".">
	<description>
		Build file for the Prelert Proxy NetQoS Plugin.
	</description>

	<property environment="env" />
	
	<!-- Set base directory properties -->
	<property name="project.basedir" value="." />
	<property name="java.basedir" value="../.." />
	<property name="resources" location="${java.basedir}/resources" />

	<!-- Read Platfrom specfic property file -->
	<condition property="property_file" value="${resources}/ant/build_linux.properties">
		<os name="Linux" />
	</condition>

	<condition property="property_file" value="${resources}/ant/build_osx.properties">
		<os family="mac" />
	</condition>

	<condition property="property_file" value="${resources}/ant/build_solaris_sparc.properties">
        <os name="SunOS" arch="sparc" />
    </condition>

    <condition property="property_file" value="${resources}/ant/build_solaris_x86.properties">
		<os name="SunOS" />
	</condition>

	<!-- Before checking for Windows, check if we're running within an msysgit shell -->
	<condition property="property_file" value="${resources}/ant/build_mingw.properties">
		<isset property="env.MSYSTEM" />
	</condition>

	<condition property="property_file" value="${resources}/ant/build_win.properties">
		<!-- Due to the test above, this means native Windows -->
		<os family="windows" />
	</condition>

	<fail message="Could not set plaftorm property file">
		<condition>
			<not>
				<isset property="property_file" />
			</not>
		</condition>
	</fail>

	<echo message="Using ${property_file}"/>

 	<property file="${property_file}" />


	<!-- Set global properties for this build -->
	<property name="name" value="prelert"/>
	<property name="src.dir" location="${java.basedir}/src" />
	<property name="build.dir" location="${project.basedir}/build" />
	<property name="git.basedir" location="${java.basedir}/.." />
	<property name="prelert.home" location="${env.PRELERT_HOME}" />
	<property name="prelert.home.proxy" value="${prelert.home}/proxy" />


	<property name="apache.basedir" location="${libs.basedir}/apache" />
	<property name="apache.commons.basedir" location="${apache.basedir}/commons" />

    <!-- boot classpath -->
    <path id="boot.classpath">   
        <fileset dir="${java6.bootstrap.path}">
            <include name="rt.jar" />
        </fileset>   
    </path>

    <!-- MySQL connector -->	
	<path id="mySQL.connector.path">
		<fileset dir="${libs.basedir}/mysql-connector-java-5.1.14/">
			<include name="mysql-connector-java-5.1.14-bin.jar" /> 
		</fileset>
	</path>

	<!-- Apache log4j JAR Path -->
	<path id="log4j.path">
		<fileset dir="${apache.basedir}/apache-log4j-1.2.16">
			<include name="log4j-1.2.16.jar" />
		</fileset>
	</path>


	<!-- Classpath for server-side classes -->
	<path id="build.classpath">
        <path refid="mySQL.connector.path" />
		<path refid="log4j.path" />
	</path>

	<target name="build" description="compile the source">
		<!-- Compiles the Java source code -->
		<echo message="Compiling the Proxy NetQoS Plugin classes" />

		<mkdir dir="${build.dir}"/>

        <!-- compile the main classes -->
        <javac srcdir="${src.dir}" destdir="${build.dir}"
			encoding="utf-8" source="1.6" target="1.6" deprecation="off" includeantruntime="false">
            <bootclasspath>
                <path refid="boot.classpath" />
            </bootclasspath>
			<classpath>
				<path refid="build.classpath" />
			</classpath>
			<compilerarg value="-Xmaxerrs"/>
			<compilerarg value="250"/>

            <include name="com/prelert/proxy/plugin/jdbc/*" />   
			<include name="com/prelert/proxy/plugin/jdbc/netqos/**" />                        
		</javac>                       
	</target>
    

	<target name="prelert-home-install" depends="build" description="Installs the Proxy NetQoS Plugin into $PRELERT_HOME/proxy/lib">
		<echo message="Installing jar files into ${prelert.home.proxy}/lib" />

		<mkdir dir="${prelert.home.proxy}"/>
		<mkdir dir="${prelert.home.proxy}/lib"/>
        
        <!-- Get the build number -->
        <condition property="build.number" value="${env.PRELERT_BUILD_NUM}" else="DEVELOPMENT BUILD by ${user.name}">
            <isset property="env.PRELERT_BUILD_NUM" />        
        </condition>
        
        <!-- Read in version properties, if it doesn't exist genver will have already failed. -->
        <property file="${git.basedir}/version.properties"/>  

		<jar destfile="${prelert.home.proxy}/lib/plugin_netqos.jar" basedir="${build.dir}">
            <include name="com/prelert/proxy/plugin/jdbc/*" />   
			<include name="com/prelert/proxy/plugin/jdbc/netqos/**" /> 
            
            <manifest>
                <attribute name="Version" value="${version.major}.${version.minor}.${version.revision}"/>
                <attribute name="Build" value="${build.number}"/>
            </manifest>
        </jar>

		<copy todir="${prelert.home.proxy}/lib" flatten="true">
			<path refid="log4j.path" />
            <path refid="mySQL.connector.path"/>
		</copy>		

		<!-- Plugin properties files are installed from the individual customer config directory. -->

	</target>

	<target name="clean" description="Clean .class files from output directories">

		<mkdir dir="${build.dir}" />

		<!-- Delete the server-side classes -->
		<delete>
			<fileset dir="${build.dir}">
                <include name="com/prelert/proxy/plugin/jdbc/*.class"/>
                <include name="com/prelert/proxy/plugin/jdbc/netqos/*.class"/>
			</fileset>
		</delete>

	</target>

</project>
