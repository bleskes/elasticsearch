<?xml version="1.0" encoding="UTF-8"?>
<project name="Prelert Desktop" default="build" basedir=".">
	<description>
        Build file for the Ext GWT Prelert desktop.
    </description>

	<!-- Set global properties for this build -->
	<property file="build.properties" />
	<property name="name" value="prelert"/>
	<property name="module-shortname" value="prelertdesktop"/>
	<property name="src" location="${project.basedir}/src/main" />
	<property name="src.config" location="${project.basedir}/config" />
	<property name="src.war" location="${project.basedir}/war" />
	<property name="build" location="${project.basedir}/build" />
	<property name="build.web.dir" value="${build}/war"/>

	<property name="gwt.entrypoint.class" value="com.prelert.Desktop" />
	<property name="gwt.sdk.location" location="C:\Tools\gwt-windows-1.7.0" />
	<property name="ext.gwt.sdk.location" location="C:\Tools\gxt-1.2.3" />

	<property name="code.drop.dir" value="${project.basedir}/gui"/>
	
	<!-- GWT Compile Classpath -->
	<path id="gwt.compile.classpath">
		<pathelement location="${gwt.sdk.location}/gwt-user.jar" />
		<pathelement location="${gwt.sdk.location}/gwt-dev-windows.jar" />
		<pathelement location="${ext.gwt.sdk.location}/gxt.jar" />
		<pathelement location="C:\Tools\gchart-2.6/gchart.jar" />
		<pathelement location="C:\Tools\gwt-incubator-july-14-2009.jar"/>
		<pathelement location="${src}" />
	</path>


	<!-- Classpath for client and server side classes -->
	<path id="build.classpath">
		<fileset dir="${appserver.lib}">
			<include name="servlet*.jar" />
		</fileset>

		<!-- GWT JARs -->
		<fileset dir="${gwt.sdk.location}">
			<include name="gwt-dev-windows.jar" />
			<include name="gwt-user.jar" />
		</fileset>
		<fileset file="C:\Tools\gwt-incubator-july-14-2009.jar"/>

		<!-- Ext GWT JARs -->
		<fileset dir="${ext.gwt.sdk.location}">
			<include name="gxt.jar" />
		</fileset>
		
		<!-- gchart JAR -->
		<fileset dir="C:\Tools\gchart-2.6">
			<include name="gchart.jar" />
		</fileset>
		
		<!-- Apache log4j JAR -->
		<fileset dir="C:\Tools\Jakarta\apache-log4j-1.2.15">
			<include name="log4j-1.2.15.jar" />
		</fileset>
		
		<!-- Apache Commons JARS -->
		<fileset dir="C:\Tools\Jakarta\commons-digester-2.0">
			<include name="commons-digester-2.0.jar" />
		</fileset>
		
		<!-- JARs required by Spring -->
		<fileset dir="C:\Tools\spring-framework-2.5.6\dist">
			<include name="spring.jar" />
		</fileset>
		<fileset dir="C:\Tools\spring-framework-2.5.6\dist\modules">
			<include name="spring-webmvc.jar" />
		</fileset>

	</path>


	<target name="gwt-compile" description="Compiles the GWT classes to generate static content">
		<!-- Compilation of the GWT classes to static content -->
		<echo message="Compiling the GWT classes to generate static content" />

		<mkdir dir="${build}/compiled_gwt" />

		<java failonerror="true" classpathref="gwt.compile.classpath" classname="com.google.gwt.dev.Compiler" fork="true" maxmemory="256m">
			<arg value="-war" />
			<arg value="${build}/compiled_gwt" />
			<arg value="${gwt.entrypoint.class}" />
		</java>
	</target>


	<target name="compile" description="compile the source">
		<!-- Compile the java code from ${src} into ${build} -->
		<echo message="Compiling the classes for the Portal" />

		<mkdir dir="${src.war}/WEB-INF/classes"/>

		<javac srcdir="${src}" destdir="${src.war}/WEB-INF/classes" source="1.6">
			<classpath>
				<path refid="build.classpath" />
			</classpath>
		</javac>
		
		<copy file="${src.config}/log4j.properties" todir="${src.war}/WEB-INF/classes" />
				
		<mkdir dir="${src.war}/WEB-INF/classes/config" />
		<copy file="${src.config}/views.xml" todir="${src.war}/WEB-INF/classes/config" />

	</target>
	
	
	<target name="copy_cs_config" description="Copies the Credit Suisse config file">
		<!-- Copy the CS views.xml config file to the build area  -->
		<copy file="${src.config}/views_cs.xml" tofile="${src.war}/WEB-INF/classes/config/views.xml" />

	</target>
	
	
	<target name="copy_statestreet_config" description="Copies the State Street config file">
		<!-- Copy the State Street views.xml config file to the build area  -->
		<copy file="${src.config}/views_statestreet.xml" tofile="${src.war}/WEB-INF/classes/config/views.xml" />

	</target>


	<target name="build" depends="compile" description="Generate the distribution">
		<echo message="Building the desktop distribution" />

		<mkdir dir="${build.web.dir}" />

		<!-- Copy the static content -->
		<copy todir="${build.web.dir}">
			<fileset dir="${src.war}">
				<include name="*.html" />
				<include name="Desktop.css" />
				<include name="gchart.gif" />
				<include name="prelert_icon.ico" />
			</fileset>
		</copy>
		<copy todir="${build.web.dir}/${module-shortname}/desktop/images">
			<fileset dir="${src.war}/${module-shortname}/desktop/images">
				<include name="**/*.*" />
			</fileset>
		</copy>

		
		<!-- Copy the compiled GWT components -->
		<copy todir="${build.web.dir}/${module-shortname}">
			<fileset dir="${build}/compiled_gwt/${module-shortname}"/>
		</copy>
		
		
		<!-- Overwrite default stylesheet to ensure the Prelert background image is used -->
		<copy todir="${build.web.dir}/${module-shortname}/desktop/css" overwrite="true">
			<fileset dir="${src.war}/${module-shortname}/desktop/css"/>
		</copy>
		

		<!-- Copy the Prelert desktop class files to the WEB-INF/classes directory -->
		<mkdir dir="${build.web.dir}/WEB-INF/classes" />
		<copy todir="${build.web.dir}/WEB-INF/classes">
			
			<fileset dir="${src.war}/WEB-INF/classes">
				<include name="**/*.*" />
			</fileset>
		</copy>


		<!-- Copy config files to the WEB-INF directory -->
		<copy todir="${build.web.dir}/WEB-INF">
			<fileset dir="${src.war}/WEB-INF">
				<include name="applicationContext.xml" />
				<include name="prelert-servlet.xml" />
			</fileset>
		</copy>
		<copy file="${src.war}/WEB-INF/tomcat-web.xml" tofile="${build.web.dir}/WEB-INF/web.xml" />
		
		<copy file="${src.config}/log4j.properties" todir="${build.web.dir}/WEB-INF/classes" />
		
		<mkdir dir="${build.web.dir}/WEB-INF/classes/config" />
		<copy file="${src.war}/WEB-INF/classes/config/views.xml" todir="${build.web.dir}/WEB-INF/classes/config" />

		<!-- Copy the necessary JARs to the WEB-INF/lib directory -->
		<copy todir="${build.web.dir}/WEB-INF/lib">

			<!-- GWT JARs -->
			<fileset dir="${gwt.sdk.location}">
				<include name="gwt-servlet.jar" />
			</fileset>

			<!-- Ext GWT JARs -->
			<fileset dir="${ext.gwt.sdk.location}">
				<include name="gxt.jar" />
				<include name="gxt-servlet.jar" />
			</fileset>
			
			<!-- log4j JAR -->
			<fileset dir="C:\Tools\Jakarta\apache-log4j-1.2.15">
				<include name="log4j-1.2.15.jar" />
			</fileset>
			
			<!-- Apache Commons JARS -->
			<fileset dir="C:\Tools\Jakarta\commons-beanutils-1.8.0">
				<include name="commons-beanutils-core-1.8.0.jar" />
			</fileset>
			<fileset dir="C:\Tools\Jakarta\commons-dbcp-1.2.2">
				<include name="commons-dbcp-1.2.2.jar" />
			</fileset>
			<fileset dir="C:\Tools\Jakarta\commons-digester-2.0">
				<include name="commons-digester-2.0.jar" />
			</fileset>
			<fileset dir="C:\Tools\Jakarta\commons-logging-1.1.1">
				<include name="commons-logging-1.1.1.jar" />
			</fileset>
			<fileset dir="C:\Tools\Jakarta\commons-pool-1.4">
				<include name="commons-pool-1.4.jar" />
			</fileset>

			<!-- MySQL Connector -->
			<fileset dir="C:\Program Files\MySQL\mysql-connector-java-5.1.7">
				<include name="mysql-connector-java-5.1.7-bin.jar" />
			</fileset>
			
			<!-- Spring JARs -->
			<fileset dir="C:\Tools\spring-framework-2.5.6\dist">
				<include name="spring.jar" />
			</fileset>
			<fileset dir="C:\Tools\spring-framework-2.5.6\dist\modules">
				<include name="spring-webmvc.jar" />
			</fileset>
			
		</copy>

		<!-- Build the WAR file -->
		<jar jarfile="${build}/${name}.war"
			basedir="${build.web.dir}"  />

	</target>


	<target name="deploy" depends="build" description="Deploy application">
		<echo message="Deploying the Prelert desktop application" />
		<delete dir="${deploy.path}/${name}"/>
		<copy file="${build}/${name}.war" todir="${deploy.path}"/>
	</target>

	
	<target name="undeploy" description="Un-deploy application">
		<delete dir="${deploy.path}/${name}"/>
		<delete file="${build}/${name}.war"/>
	</target>

	
	<target name="setup_project" description="Sets up project libraries">
		<echo message="Setting up libraries required for GWT project structure" />

		<mkdir dir="${src.war}/WEB-INF/lib" />
		
		<!-- Copy the necessary JARs to the WEB-INF/lib directory -->
		<copy todir="${src.war}/WEB-INF/lib">

			<!-- GWT JARs -->
			<fileset dir="${gwt.sdk.location}">
				<include name="gwt-servlet.jar" />
			</fileset>

			<!-- Ext GWT JARs -->
			<fileset dir="${ext.gwt.sdk.location}">
				<include name="gxt.jar" />
				<include name="gxt-servlet.jar" />
			</fileset>
			
			<!-- log4j JAR -->
			<fileset dir="C:\Tools\Jakarta\apache-log4j-1.2.15">
				<include name="log4j-1.2.15.jar" />
			</fileset>
			
			<!-- Apache Commons JARS -->
			<fileset dir="C:\Tools\Jakarta\commons-beanutils-1.8.0">
				<include name="commons-beanutils-core-1.8.0.jar" />
			</fileset>
			<fileset dir="C:\Tools\Jakarta\commons-dbcp-1.2.2">
				<include name="commons-dbcp-1.2.2.jar" />
			</fileset>
			<fileset dir="C:\Tools\Jakarta\commons-digester-2.0">
				<include name="commons-digester-2.0.jar" />
			</fileset>
			<fileset dir="C:\Tools\Jakarta\commons-logging-1.1.1">
				<include name="commons-logging-1.1.1.jar" />
			</fileset>
			<fileset dir="C:\Tools\Jakarta\commons-pool-1.4">
				<include name="commons-pool-1.4.jar" />
			</fileset>

			<!-- MySQL Connector -->
			<fileset dir="C:\Program Files\MySQL\mysql-connector-java-5.1.7">
				<include name="mysql-connector-java-5.1.7-bin.jar" />
			</fileset>
			
			<!-- Spring JARs -->
			<fileset dir="C:\Tools\spring-framework-2.5.6\dist">
				<include name="spring.jar" />
			</fileset>
			<fileset dir="C:\Tools\spring-framework-2.5.6\dist\modules">
				<include name="spring-webmvc.jar" />
			</fileset>
			
		</copy>
		
	</target>
	
	<target name="clean" description="Clean .class files and GWT files from output directories">
		<delete>
			<fileset dir="${src.war}/WEB-INF/classes">
				<include name="**/*.class"/>
			</fileset>
		</delete>
		
		<delete>
			<fileset dir="${build}/compiled_gwt/${module-shortname}">
				<include name="**/*.*" />
			</fileset>
		</delete>
		
		<delete>
			<fileset dir="${build.web.dir}">
				<include name="**/*.*"/>
			</fileset>
		</delete>
		
	</target>
	
	
	<target name="codedrop" description="Copies source code and associated files to single directory">
		<echo message="Copying source to single dir" />

		<mkdir dir="${code.drop.dir}" />
		<mkdir dir="${code.drop.dir}/config" />
		<mkdir dir="${code.drop.dir}/procs" />
		<mkdir dir="${code.drop.dir}/src/main" />
		<mkdir dir="${code.drop.dir}/war" />
		
		<!-- Copy the build files -->
		<copy todir="${code.drop.dir}">
			<fileset dir="${project.basedir}">
				<include name="build.xml" />
				<include name="build.properties" />
			</fileset>
		</copy>
			
		<!-- Copy the config files -->
		<copy todir="${code.drop.dir}/config">
			<fileset dir="${src.config}">
				<include name="log4j.properties" />
				<include name="**/*.xml" />
			</fileset>
		</copy>
			
		<!-- Copy the Java source files -->
		<copy todir="${code.drop.dir}/src/main">
			<fileset dir="${src}">
				<include name="**/*.java" />
			</fileset>
		</copy>
		
		<!-- Copy the static content -->
		<copy todir="${code.drop.dir}/war">
			<fileset dir="${src.war}">
				<include name="*.*"/>
			</fileset>
		</copy>
		<copy todir="${code.drop.dir}/war/prelertdesktop/desktop">
			<fileset dir="${src.war}/prelertdesktop/desktop">
				<include name="**/*.*"/>
				<exclude name="wallpapers/*.*"/>
			</fileset>
		</copy>
		<copy file="${src}/com/prelert/Desktop.gwt.xml" todir="${code.drop.dir}/src/main/com/prelert"/>
		
		<!-- Copy the web config files -->
		<copy todir="${code.drop.dir}/war/WEB-INF">
			<fileset dir="${src.war}/WEB-INF">
				<include name="*.xml" />
			</fileset>
		</copy>
		
		<!-- Copy the database procs and remove .sql extension -->
		<copy todir="${code.drop.dir}/procs">
			<fileset dir="${project.basedir}/procs">
				<include name="*.sql" />
			</fileset>
			<mapper type="glob" from="*.sql" to="*"/>
		</copy>
		
	</target>

</project>
